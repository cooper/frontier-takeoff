<!doctype html>
<html>
<head>
<meta name="studentconfig" contents="{ 'lcs_host': '172.16.1.73', 'lcs_port': 8080, 'channel': 1228, 'change_channel': false, 'allow_prefs': false }" />
<title>Falcon Takeoff</title>
<script type="text/javascript" src="mootools.js"></script>
<link rel="icon" type="image/png" href="falcon.png" />
<link href="http://fonts.googleapis.com/css?family=Open+Sans:400,600" rel="stylesheet" type="text/css" />
<script type="text/javascript">
    
    var baseURL         = 'https://docs.google.com/a/frontier.k12.in.us/spreadsheets/d/',
        announcementsID = '1WdvyXz6LbB12GknlRO0QY8vFHTkCX4zoHkQ6i10Xcfw',
        mealsID         = '1a2G6_26ygUNKcFdf90SQYV9noIUvaTufkcBUo6s0zBs';
    
    // this is basically a trick to avoid using Google's huge APIs for something so simple.
    var google = { visualization: { Query: { setResponse: handleResponse } } };
    
    var d = new Date();
    var dateStr = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
    
    function injectAnnouncementsRequest () {
        var query = "select * where D=date '"+dateStr+"' order by A desc limit 1";
        
        // inject a script tag for Google's spreadsheet APIs.
        query = encodeURIComponent(query);
        var script  = new Element('script', {
            src:  baseURL + announcementsID + '/gviz/tq?tq=' + query,
            type: 'text/javascript'
        });
        
        document.head.adopt(script);
    }
    
    function injectMealsRequest () {
        var query = "select * where F=date '"+dateStr+"' order by A desc limit 1";
        
        // inject a script tag for Google's spreadsheet APIs.
        query = encodeURIComponent(query);
        var url = baseURL + mealsID + '/gviz/tq?tq=' + query;
        var script  = new Element('script', {
            src:   url,
            type: 'text/javascript'
        });
        
        document.head.adopt(script);
    }
    
    function handleResponse (res) {
        
        // some error occurred.
        if (res.status != 'ok') return;
        
        if (res.table.cols[1].label == 'General announcements') {
            if (!handleAnnouncementsResponse(res))
                $('sad-falcon').setStyle('display', 'block');
        }
        else
            handleMenuResponse(res);
    }
    
    function handleAnnouncementsResponse (res) {
        var announcements = $('to-announcements'),
            meetings      = $('to-meetings');
        
        // consider: if not logged in, this will be a redirect...
        // how will Chrome handle a <script> tag leading to text/html?
        // probably just won't do anything.
                
        // the row will be the first and only row, since the query
        // limits to one result.
        var row = res.table.rows[0];
        if (!row) return;
         
        // 0 (A) Timestamp
        // 1 (B) Announcements
        // 2 (C) Username
        // 3 (D) Date for announcements
        // 4 (E) Meetings
        
        // the date is not today.
        if (row.c[3].v.toDateString() != new Date().toDateString())
            return;
        
        if (row.c[1].v) {
            announcements.innerText = row.c[1].v;
            announcements.boldifyToday();
        }
        
        if (row.c[4].v) {
            meetings.innerText = row.c[4].v;
            meetings.setStyle('display', 'block');
            $('to-meetings-header').setStyle('display', 'block');
            meetings.boldifyToday();
        }
        
        $('to-announcements-header').setStyle('display', 'block');
        return true;
    }
    
    function handleMenuResponse (res) {
        var meals = $('to-meals'),
            lunch = $('to-lunch'),
            bkfst = $('to-breakfast'),
            row   = res.table.rows[0];
        if (!row) return;
        
        // 0 (A) Timestamp
        // 1 (B) Username
        // 2 (C) Lunch
        // 3 (D) Breakfast
        // 4 (E) Salad choice
        // 5 (F) Date it applies to
        
        // set breakfast, lunch, and salad.
        if (row.c[3].v) bkfst.innerText = row.c[3].v;
        if (row.c[2].v) lunch.innerText = row.c[2].v;
        if (row.c[4].v) lunch.innerText += "\n\n" + row.c[4].v + ' salad';
        
        // show these if there's info to put there.
        if (bkfst.innerText || lunch.innerText)
            meals.setStyle('display', 'block');
        
        return true;
    }
    
    Element.implement('boldifyToday', function () {
        var day = [
            'Sunday',
            'Monday',
            'Tuesday',
            'Wednesday',
            'Thursday',
            'Friday',
            'Saturday'
        ][d.getDay()];
        var re = new RegExp(day, 'g');
        console.log(re);
        this.innerHTML = this.innerHTML.replace(re, '<b>' + day + '</b>');
        this.innerHTML = this.innerHTML.replace(/Today/g, '<b>Today</b>');        
    });
    
    document.addEvent('domready', injectAnnouncementsRequest);
    document.addEvent('domready', injectMealsRequest);

</script>
<style type="text/css">
    * {
        padding: 0;
        margin: 0;
    }
    
    body {
        font-family: 'Open Sans';
        background-color: #333;
    }
    
    #to-sidebar, #to-left {
        height: 100%;
        position: fixed; 
        top: 0;
        bottom: 0;
    }
    
    #sad-falcon {
        text-align: center;
        margin: 20px;
        display: none;
    }
    
    #sad-falcon img {
        border: 5px solid #d64141;
    }
    
    #to-sidebar {
        float: right;
        width: calc(100% - 920px);
        max-width: 450px;
        border-left: 1px solid #111;
        right: 0;
        z-index: 1;
        overflow-y: auto;
        background-color: #fff;
    }
    
    #to-left {
        width: 900px;
        left: 0;
        z-index: 0;
        background: url(falcon.png) center 30% no-repeat #333;
    }
    
    #to-sidebar-logo {
        width: 100%;
        display: block;
    }
    
    .th-sidebar-section {
        padding: 10px;
        display: none;
    }
    
    #to-meals { padding: 0; }
    #to-announcements { display: block; }
    
    #to-sidebar h2 {
        background-color: #d64141;
        padding: 10px;
        color: #fff;
        font-size: 20px;
        display: none;
        height: 25px;
    }
    
    #to-menu-table {
        border-collapse: collapse;
        width: 100%;
    }
    
    #to-menu-table td {
        padding: 5px 10px;
        width: 50%;
        vertical-align: top;
    }
    
    #to-menu-table th {
        color: #fff;
        text-align: left;
        vertical-align: middle;
        padding: 10px;
        font-size: 20px;
        height: 25px;
    }
    
    #to-breakfast {
        border-right: 1px dashed #ccc;
    }
    
    iframe {
        width: 920px;
        height: 100%;
        overflow: hidden;
        background: transparent !important;
    }
    
</style>
</head>
    
<body>
    <div id="to-sidebar">
        <img id="to-sidebar-logo" src="header.png" alt="Frontier" />
        
        <h2 id="to-announcements-header">Announcements</h2>
        <div class="th-sidebar-section" id="to-announcements">
            <div id="sad-falcon">
                <img src="sad-falcon.jpg" alt=":(" /><br /><br />
                <b>Today's announcements have not been posted.</b>
            </div>
        </div>
        
        <h2 id="to-meetings-header">Meetings</h2>
        <div class="th-sidebar-section" id="to-meetings"></div>
        
        <div class="th-sidebar-section" id="to-meals">
            <table id="to-menu-table">
            <tr style="background-color: #d64141">
                <th>Breakfast</th>
                <th>Lunch</th>
            </tr>
            <tr>
                <td id="to-breakfast"></td>
                <td id="to-lunch"></td>
            </tr>
            </table>
        </div>
    </div>
    <div id="to-left">
        <iframe scrolling="no" frameborder="0" noresize="noresize" src="http://www.symbaloo.com/embed/home1982?widget=26&bgcolor=333333" name="_symFrame">
        </iframe>
    </div>
</body>
</html>
